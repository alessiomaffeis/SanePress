(function(e){window.ImageModel=Backbone.Model.extend({defaults:{attachment_id:null,url:null,alt:null,title:null,sizes:null}});window.ImageCollection=Backbone.Collection.extend({model:ImageModel,_primary:0,initialize:function(){var e=this;this.on("add",this.addModel,this);this.on("remove",this.removeModel,this);this.on("reset",this.resetData,this);this.on("change",this.resetData,this);setTimeout(function(){_.each(e.models,function(t){e._primary++})})},addModel:function(e){this._primary++;e.set({id:this._primary},{silent:true});this.reset(this.models,{silent:true});this.resetData()},removeModel:function(){var e=this;this.resetIDs();this.reset(this.models,{silent:true});this.resetData()},resetData:function(){e("#gallery-images").val(JSON.stringify(this))},resetIDs:function(){this._primary=0;_.each(this.models,function(e){this._primary++;e.set({id:this._primary},{silent:true})},this);return this}});window.GalleryView=wp.media.View.extend({$container:e(".thumbnails-container .inner"),template:wp.media.template("gallery-thumbnail"),initialize:function(){var t=this;this.collection.on("add",this.addThumb,this);this.collection.on("remove",this.render,this);this.collection.on("reset",this.render,this);e(document).delegate(".delete-images","click",function(e){e.preventDefault();if(confirm(rocketgalleries.delete_images))t.removeThumbs.call(t,e)});e(document).delegate(".add-image","click",function(e){e.preventDefault();t.addImageView=(new AddImageView({collection:t.collection})).render()});e(document).delegate(".delete-button","click",function(n){n.preventDefault();if(confirm(rocketgalleries.delete_image))t.collection.remove(t.collection.get(e(this).parent().attr("data-id")))})},addThumb:function(e){this.$container.append(this.template(e.toJSON()))},removeThumbs:function(e){e.preventDefault();this.$container.empty();this.collection.reset();this.collection._primary=0},render:function(){this.$container.empty();_.each(this.collection.models,function(e){this.$container.append(this.template(e.toJSON()))},this);return this}});window.AddImageView=Backbone.View.extend({fileFrame:null,frameProperties:{title:rocketgalleries.media_upload.title,button:rocketgalleries.media_upload.button,multiple:true},modelAttributes:{attachment_id:"id",url:"url",alt:"alt",title:"title",sizes:"sizes"},initialize:function(){if(this.fileFrame)return;this.fileFrame=wp.media.frames.fileFrame=wp.media({title:this.frameProperties.title,button:{text:this.frameProperties.button},multiple:this.frameProperties.multiple});this.fileFrame.on("select",this.onSelect,this)},onSelect:function(){var e=this.fileFrame.state().get("selection");_.each(e.models,function(e){var t={};_.each(this.modelAttributes,function(n,r){t[r]=e.get(n)},this);this.collection.add([t])},this)},render:function(){this.fileFrame.open();return this}});wp.media.view.Attachment.Details.prototype.template=wp.media.template("gallery-media-sidebar");e(".sidebar-name").bind("click",function(){var t=e(this).parent(),n=t.find(".sidebar-content");if(!t.hasClass("exclude")){e(".sidebar-name").each(function(){var t=e(this).parent();if(!t.hasClass("exclude")&&!t.hasClass("closed")){t.find(".sidebar-content").slideUp(200,function(){t.addClass("closed")})}})}if(t.hasClass("closed"))n.slideDown(200,function(){t.removeClass("closed")});else n.slideUp(200,function(){t.addClass("closed")})});setTimeout(function(){e(".message").not(".permanent").each(function(){e(this).fadeOut(400,function(){e(this).remove()})})},5e3);e(".warn").bind("click",function(){if(!confirm(rocketgalleries.warn))return false});if(e("#gallery-images").length==0)return;window.imageCollection=new ImageCollection(JSON.parse(e("#gallery-images").val()));window.galleryView=(new GalleryView({collection:imageCollection})).render();e(".thumbnails-container").sortable({items:".thumbnail",containment:"parent",tolerance:"pointer",stop:function(t,n){var r=[],i=[];e(this).find(".thumbnail").each(function(){r.push(e(this).attr("data-id"))});for(var s=0;s<r.length;s++)i.push(imageCollection.get(r[s]));imageCollection.reset(i).resetIDs().resetData()}})})(jQuery)